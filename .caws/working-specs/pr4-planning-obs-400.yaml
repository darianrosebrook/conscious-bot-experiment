id: PR4-PLANNING-OBS-400
title: "Instrument planning 400s for thought ingestion"
risk_tier: 2
feature_flag: "PLANNING_INGEST_DEBUG_400=1"
scope:
  in:
    - "Add structured 400 rejection logging at the planning ingestion endpoint"
    - "Echo request id and include validation details in 400 response (debug only)"
    - "Log caller-side 400 response body text (truncated) with hash in cognition"
    - "Temporarily gate ACKs to avoid dropping failing thoughts (debug only)"
  out:
    - "Changing task conversion semantics"
    - "Altering Sterling reduction contents or schema"
invariants:
  - "No semantic interpretation added to planning."
  - "Logs include key presence booleans only (no full content)."
  - "Any 400 response includes rejection reason or validation issues when debug flag is enabled."
  - "ACK gating only active when debug flag enabled."
  - "Instrumentation does not allocate or stringify full request body unless debug flag enabled and response is 400."
acceptance:
  - id: A1
    given: "planning receives a malformed thought payload"
    when: "endpoint returns 400"
    then: "logs include request id, route, content-type, size, top-level keys, and missing required fields"
  - id: A2
    given: "planning returns 400"
    when: "cognition submits the request"
    then: "cognition logs URL, status code, and response body text (truncated) with hash"
  - id: A3
    given: "thought is rejected due to missing fields"
    when: "planning is in debug mode"
    then: "thought is not ACKed for a bounded number of retries"
  - id: A4
    given: "debug flag is off"
    when: "400 occurs"
    then: "response does not include validation issues and logs include only baseline info"
non_functional:
  a11y: []
  perf:
    api_p95_ms: 250
  security:
    - "No logging of full thought content or PII"
contracts:
  - type: openapi
    path: "TBD: resolve planning ingest contract path before merge"
observability:
  logs:
    - "planning.thought_ingest.reject with missing_fields (debug only)"
    - "planning.thought_ingest.request with key_presence (debug only)"
    - "cognition.planning_bridge.error with response_body_hash (debug only)"
  metrics:
    - "planning_thought_ingest_400_total{reason_code}"
    - "planning_thought_ingest_missing_field_total{field}"
  traces: []
migrations: []
rollback:
  - "Disable PLANNING_INGEST_DEBUG_400 and remove debug logging + ack gating"
